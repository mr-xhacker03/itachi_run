<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Itachi Run - Telegram Edition</title>
    <script src="https://telegram.org/js/games.js"></script>
    <style>
        body { background: #000; color: white; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; }
        #game-container { position: relative; width: 100%; max-width: 800px; margin-top: 10px; border: 3px solid #f00; border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px #f00; }
        canvas { background: linear-gradient(#1a2a6c, #b21f1f, #fdbb2d); display: block; width: 100%; height: auto; }
        
        .hud { position: absolute; width: 100%; top: 10px; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 10; }
        #score { font-size: 20px; text-shadow: 2px 2px #000; font-weight: bold; }
        #status { color: #ff0000; font-weight: bold; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid #f00; }

        .controls { display: flex; justify-content: space-around; width: 100%; position: fixed; bottom: 30px; z-index: 100; }
        .btn { width: 95px; height: 95px; border: 4px solid #fff; border-radius: 50%; color: white; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .btn-sharingan { background: radial-gradient(circle, #f00 20%, #000 100%); border-color: #f00; box-shadow: 0 0 20px #f00; }
        .btn-jump { background: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .cooldown { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        #tmr { font-size: 20px; color: yellow; margin-top: 2px; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="hud">
        <div id="score">Score: 0</div>
        <div id="status">『ǤØĐ』༒ ɪᴛᴀᴄʜɪ</div>
        <div></div> </div>
    <canvas id="gameCanvas"></canvas>
</div>

<audio id="voice" src="itachi_sonosharingan.mp3" preload="auto"></audio>

<div class="controls">
    <div class="btn btn-sharingan" id="shBtn">
        <span>SHARINGAN</span>
        <div id="tmr"></div>
    </div>
    <div class="btn btn-jump" id="jpBtn">JUMP</div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const tmrDiv = document.getElementById('tmr');
    const voice = document.getElementById('voice');
    const scoreDiv = document.getElementById('score');

    canvas.width = 800; canvas.height = 400;

    let score = 0, gameActive = true, frame = 0, gravity = 0.6;
    let isInvincible = false, canUseSharingan = true;

    let itachi = {
        x: 80, y: 280, w: 60, h: 100, dy: 0, jumpF: 14, grounded: false,
        draw() {
            ctx.save();
            let walk = Math.sin(frame * 0.25) * 12;
            let bounce = Math.abs(Math.sin(frame * 0.25)) * 6;
            let cy = this.y + (this.grounded ? bounce : 0);
            if(isInvincible) {
                ctx.shadowBlur = 35; ctx.shadowColor = "red";
                ctx.strokeStyle = "red"; ctx.lineWidth = 5;
                ctx.strokeRect(this.x-5, cy-5, this.w+10, this.h+10);
            }
            ctx.fillStyle = "#111"; // Legs
            ctx.fillRect(this.x+15+walk, cy+80, 14, 20); ctx.fillRect(this.x+35-walk, cy+80, 14, 20);
            ctx.fillStyle = "black"; // Cloak
            ctx.fillRect(this.x, cy+30, 60, 55); 
            ctx.fillStyle = "#ffdbac"; // Face
            ctx.fillRect(this.x+15, cy-5, 40, 40); 
            ctx.fillStyle = isInvincible ? "red" : "#600"; // Eyes
            ctx.beginPath(); ctx.arc(this.x+25, cy+15, 6, 0, Math.PI*2); ctx.arc(this.x+45, cy+15, 6, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "black"; // Hair
            ctx.fillRect(this.x+10, cy-15, 50, 20); ctx.fillRect(this.x+8, cy-10, 12, 65); ctx.fillRect(this.x+48, cy-10, 12, 65); ctx.fillRect(this.x+55, cy+10, 15, 45); 
            ctx.restore();
        }
    };

    let obstacles = [];
    function drawBG() {
        ctx.fillStyle = "#3d2b1f"; 
        [200, 500, 850].forEach((p, i) => {
            ctx.beginPath(); ctx.moveTo(p-250, 380); ctx.lineTo(p, 120+i*40); ctx.lineTo(p+250, 380); ctx.fill();
        });
        ctx.fillStyle = "#654321"; ctx.fillRect(0, 380, 800, 20);
        ctx.fillStyle = "#2e7d32"; ctx.fillRect(0, 375, 800, 10);
        for(let i=0; i<800; i+=15) { ctx.beginPath(); ctx.moveTo(i, 375); ctx.lineTo(i+8, 350); ctx.lineTo(i+16, 375); ctx.fill(); }
    }

    function doJump() {
        if (itachi.grounded && gameActive) { itachi.dy = -itachi.jumpF; itachi.grounded = false; }
        else if (!gameActive) location.reload();
    }

    function doSharingan() {
        if (canUseSharingan && gameActive) {
            voice.currentTime = 0;
            voice.play().catch(e => console.log("Sound error"));
            isInvincible = true; canUseSharingan = false;
            statusText.innerText = "SHARINGAN ACTIVE!";
            document.getElementById('shBtn').classList.add('cooldown');
            setTimeout(() => { isInvincible = false; statusText.innerText = "『ǤØĐ』༒ ɪᴛᴀᴄʜɪ"; }, 3500);
            let t = 30; tmrDiv.innerText = t;
            let iv = setInterval(() => {
                t--; tmrDiv.innerText = t;
                if(t <= 0) { clearInterval(iv); tmrDiv.innerText = ""; canUseSharingan = true; document.getElementById('shBtn').classList.remove('cooldown'); }
            }, 1000);
        }
    }

    document.getElementById('jpBtn').addEventListener('mousedown', doJump);
    document.getElementById('jpBtn').addEventListener('touchstart', (e) => { e.preventDefault(); doJump(); });
    document.getElementById('shBtn').addEventListener('mousedown', doSharingan);
    document.getElementById('shBtn').addEventListener('touchstart', (e) => { e.preventDefault(); doSharingan(); });

    function loop() {
        if (!gameActive) return;
        frame++; ctx.clearRect(0, 0, 800, 400); drawBG();
        itachi.dy += gravity; itachi.y += itachi.dy;
        if (itachi.y + itachi.h > 375) { itachi.y = 375 - itachi.h; itachi.dy = 0; itachi.grounded = true; }
        if (Math.random() < 0.02) obstacles.push({ x: 800, y: 345, w: 30, h: 30, r: 0 });
        obstacles.forEach((o, i) => {
            o.x -= (8 + score/150); o.r += 0.2;
            if (itachi.x < o.x + o.w && itachi.x + itachi.w > o.x && itachi.y < o.y + o.h && itachi.y + itachi.h > o.y) {
                if(!isInvincible) gameOver();
            }
            if (o.x < -50) obstacles.splice(i, 1);
        });
        score += 0.1; scoreDiv.innerText = "Score: " + Math.floor(score);
        itachi.draw(); ctx.fillStyle = "#ccc";
        obstacles.forEach(o => { ctx.save(); ctx.translate(o.x+15, o.y+15); ctx.rotate(o.r); ctx.fillRect(-15, -15, 30, 30); ctx.restore(); });
        requestAnimationFrame(loop);
    }

    function gameOver() {
        gameActive = false;
        let finalScore = Math.floor(score);
        
        // --- TELEGRAM NATIVE SCORE SUBMISSION ---
        if (window.TelegramGameProxy) {
            // Ye function Telegram ke interface par share/score update ka option dega
            window.TelegramGameProxy.receiveEvent("score", finalScore);
        }

        alert("Mission Failed! Score: " + finalScore);
        location.reload();
    }

    loop();
</script>
</body>
</html>
